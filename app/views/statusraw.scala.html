@import models.{Message, Version}
@(versions: Seq[(Version, Option[String], Option[Long])], message: Option[Message], total: Long)

<h1>Current versions</h1>
<table>
  <tr>
    <th>Kind</th>
    <th>Version name</th>
    <th>Version code</th>
    <th><span title="Estimation based on recent status requests">Users online (estimated)</span></th>
    <th>% (estimated)</th>
  </tr>
  @for((version, url, users) <- versions; kind = version.kind.name) {
    <tr>
      <td>@url match {
            case Some(u) => {
              <a href="@u" target="_top">@kind</a>
            }
            case None    => {
              @kind
            }
          }
      </td>
      <td>@version.name</td>
      <td>@version.code match {
          case n if n == 0 => { }
          case n           => { @n.toString }
      }</td>
      <td>@(users.map(_.toString).getOrElse("?"))</td>
      <td>@(users.map(u => "%.1f%%".format(100.0 * u / total)).getOrElse("?"))</td>
    </tr>
  }
  <tr>
      <th></th>
      <th></th>
      <th></th>
      <th>@(if (total == 0) "" else ("Total: " + total.toString))</th>
      <th></th>
  </tr>
</table>

@message.map { m =>
  <br class="large"/>
  <h1>Current message</h1>
  <table>
    <tr><th>Message</th><th>Message id</th><th>Icon</th><th>URL</th></tr>
    <tr>
      <td>@m.message</td>
      <td>@m.message_id.getOrElse("")</td>
      <td>@{m.icon match {
	case None =>
	case Some(name: String) =>
	  val icon: String = "icons/" + name + ".png"
	  <img src={routes.Assets.at(icon).toString} title={name} alt={name}/>
	}}</td>
      <td>@{m.url match {
	case None =>
	case Some(url: String) => <a href={url} target="_top">{url}</a>
      }}</td>
    </tr>
  </table>
}

<br class="large"/>
<h1>Older versions and source code</h1>

Former releases of c:geo and their source code can be found on <a href="https://github.com/cgeo/cgeo/releases" target="_top">c:geo GitHub release page</a>.

<br/>
<br/>
<br/>
<h1>Active users</h1>
<div id="map"></div>

<script>
     var map;
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 48.0, lng: -30.0},
          zoom: 3,
          fullscreenControl: true,
          streetViewControl: false,
          rotateControl: false,
          scaleControl: false
        });
        var heatmapData = [];
        var heatmap = new google.maps.visualization.HeatmapLayer({
            dissipating: true,
            radius: 30
        });
        heatmap.setMap(map);
        var ws = new WebSocket("wss://cgeo-status.herokuapp.com/api/locations");
        ws.onmessage = function(msg) {
            var data = JSON.parse(msg.data);
            data.clients.map(function(client) {
                var label = client.kind[0].toUpperCase()
                heatmapData.push(new google.maps.LatLng(client.latitude, client.longitude));
                var marker = new google.maps.Marker({
                    position: {lat: client.latitude, lng: client.longitude},
                    map: map,
                    label: label
                });
                window.setTimeout(function() { marker.setMap(null); }, 10000);
            });
        };
        window.setInterval(function() {
            if (heatmapData.length > 1000)
                heatmapData.splice(0, heatmapData.length - 1000);
            heatmap.setData(heatmapData);
        }, 10000);

      }
</script>

<script src="//maps.googleapis.com/maps/api/js?key=AIzaSyCAdIFp-YuYxGpOkcIpPwJ0B0XRZvJbHME&callback=initMap&libraries=visualization" async defer></script>
